/// <reference path="jquery-1.7.2.js" />
/// <reference path="jquery-ui-1.8.20.js" />
/// <reference path="jquery.ui.selectmenu.js" />
/// <reference path="jquery.query.js" />
/// <reference path="jquery.hoverIntent.js" />
/// <reference path="jqFancyTransitions.1.8.min.js" />

$(function () {

    $('.jqui-butttons').buttonset();
    $(".jqui-button").button();

    var select = $("#head-nav .search select");
    select.selectmenu({
        width: 110,
        menuWidth: 130,
        positionOptions: {
            my: "right top",
            at: "right bottom",
            offset: null
        },
        wrapperElement: "<div class='selectmenu-wrp' />"
    });

    $("#slider").jqFancyTransitions({ width: 960, height: 430, delay: 3000 });

    $("a[href].popup-player").live("click", function () {
        var url = $(this).attr("href");
        var title = $(this).attr("title");
        var html = ["<div class='popup-player'>",
            "<object width='640' height='360'>",
            "<param name='movie' value='" + url + "'></param>",
            "<param name='allowFullScreen' value='true'></param>",
            "<param name='allowscriptaccess' value='always'></param>",
            "<param name='wmode' value='transparent'></param>",
            "<embed src='" + url + "' type='application/x-shockwave-flash' width='640' height='360' allowscriptaccess='always'",
            "allowfullscreen='true' wmode='transparent'></embed></object>",
            "</div>"].join("\n");

        var $div = $(html).appendTo('body');

        $div.dialog({
            modal: true,
            resizable: false,
            title: title,
            width: 670,
            height: 410,
            position: "center middle",
            close: function (event, ui) {
                $div.remove();
            }
        });

        return false;
    });

    if ($(".gallery .search-box").length == 1) {
        var searchBox = $(".gallery .search-box");

        $(document).live("focusin", function (e) {
            if (searchBox.has(e.target).length > 0) {
                $('.classification', searchBox).css("visibility", "visible").fadeIn("fast");
            } else {
                $('.classification', searchBox).fadeOut("fast");
            }
        }).live("click", function (e) {
            if (searchBox.has(e.target).length == 0) {
                $('.classification', searchBox).fadeOut("fast");
            }
        });
    }

    if ($("#sideTabs").length > 0) {
        var sideTabs = $("#sideTabs");
        var secondsToClose = 1;
        var timerToClose;

        sideTabs.mouseover(function (e) {
            if ($(e.target).is(".tab") || $(e.target).is(".content") || $(e.target).parents(".content").length > 0) {

                clearTimeout(timerToClose);
                sideTabs.addClass("tab-hover");

                if (!sideTabs.is(".folded")) {
                    sideTabs.removeClass("folded", 500, "easeOutExpo");
                }
            }
        })
        .mouseout(function (e) {
            if ($(e.target).is(".tab") || $(e.target).is(".content") || $(e.target).parents(".content").length > 0) {

                sideTabs.removeClass("tab-hover");

                timerToClose = setTimeout(function () {
                    clearTimeout(timerToClose);
                    if (!sideTabs.is(".folded")) {
                        sideTabs.addClass("folded", 500, "easeOutExpo");
                    }
                }, secondsToClose * 1000);

            }
        });

        $("#sideTabs .tab").click(function () {
            if (sideTabs.is(".folded")) {
                sideTabs.removeClass("folded", 500, "easeOutExpo");
            }

            $("#sideTabs .tab").removeClass("selected");
            $(this).addClass("selected");

            if ($(this).is(".album")) {
                $("#sideTabs .content .cart").hide();
                $("#sideTabs .content .album").show();
            } else if ($(this).is(".cart")) {
                $("#sideTabs .content .cart").show();
                $("#sideTabs .content .album").hide();
            }

            return false;
        });

        function setPhotosScrollerHeight() {
            $(".photos", sideTabs)
                .css("overflow-y", "scroll")
                .height(sideTabs.innerHeight() - 250);
        }

        setPhotosScrollerHeight();

        $(window).resize(setPhotosScrollerHeight);
    }

    if ($("#loginPopupDiv").length === 1) {
        $("#loginPopupDiv").position({
            my: "center top",
            at: "center bottom",
            offset: "0px -5px",
            of: $("a.login-link")
        });

        $("a.login-link").click(function () {
            $("#loginPopupDiv").fadeIn("fast");
            return false;
        });

        $(document).mouseup(function (e) {
            var container = $("#loginPopupDiv");

            if (container.has(e.target).length === 0) {
                container.fadeOut("fast");
            }
        });
    } else if ($("#myAccountPopupDiv").length === 1) {
        $("#myAccountPopupDiv").position({
            my: "right top",
            at: "right bottom",
            offset: "0px 3px",
            of: $("a.my-account")
        });

        $("a.my-account").click(function () {
            $("#myAccountPopupDiv").fadeIn("fast");
            return false;
        });

        $(document).mouseup(function (e) {
            var container = $("#myAccountPopupDiv");

            if (container.has(e.target).length === 0) {
                container.fadeOut("fast");
            }
        });
    }

    if ($(".page-order").length > 0) {
        $("#pnlAddNewCoupon").hide();

        $("a.new-coupon").live("click", function (e) {
            e.preventDefault();
            var dlg = $("#pnlAddNewCoupon").dialog({
                modal: true,
                resizable: false
            });
            dlg.parent().appendTo($("form:first"));
        });

        $("#btnAddNewCoupon").click(function () {
            $("#pnlAddNewCoupon").dialog("close");
        });
    }

    if ($("#loginOrRegisterPopup").length === 1) {
        (function () {
            var $dialog = $("#loginOrRegisterPopup").position({
                my: "center",
                at: "center",
                of: window
            });

            $(".must-login").live("click", function (e) {
                e.preventDefault();
                e.stopPropagation();

                showDialog();
            });

            $(".close", $dialog).live("click", function (e) {
                hideDialog();
                e.preventDefault();
            });

            function showDialog() {
                $("#modalBackground").show();
                $dialog.show();
                window.scrollTo(0, 0);
            }

            function hideDialog() {
                $("#modalBackground").hide();
                $(".validation-error", $dialog).remove();
                $(".field input", $dialog).val("");
                $dialog.hide();
            }

            if (window['showLoginPopupDialog'] != undefined) {
                showDialog();
            }
        })();
    }

    if ($(".page-classification").length > 0) {
        $(".jqui-dropdownchecklist").dropdownchecklist({
            icon: {},
            firstItemChecksAll: true,
            width: "150px",
            positionHow: "position",
            dropSnapping: (($(this).parents("body.he").length > 0) ? "left" : "right"),
            maxDropHeight: "300px"
        });
    }

    if ($('.page-photos').length > 0 || $('.page-photo').length > 0) {

        $(".jqui-dropdownchecklist").dropdownchecklist({
            icon: {},
            firstItemChecksAll: true,
            width: "140px",
            positionHow: "position",
            dropSnapping: (($(this).parents("body.he").length > 0) ? "right" : "left"),
            maxDropHeight: "300px"
        });

        $("a.filter-show-results")
            .button()
            .live("click", function () {
                var types = $("#lstTypeFilter").val();
                var photographers = $("#lstPhotographersFilter").val();
                var licenses = $("#lstLicenseFilter").val();
                var query = $.query;

                var filter = {};

                if (query.get("filter")) {
                    var oldFilter = JSON.parse(query.get("filter"));

                    if (oldFilter["tags"]) {
                        filter.tags = oldFilter.tags;
                    }
                }

                if (types != null && types.length > 0 && types[0] != "all") {
                    filter.type = types[0];
                }

                if (photographers != null && photographers.length > 0 && photographers[0] != "all") {
                    filter.photographers = photographers;
                }

                if (licenses != null && licenses.length > 0 && licenses[0] != "all") {
                    filter.licenses = licenses;
                }

                if ($.isEmptyObject(filter)) {
                    query = query.remove("filter");
                } else {
                    query = query.set("filter", JSON.stringify(filter));
                }

                if ($(this).attr("href") != "#") {
                    location = $(this).attr("href") + query.toString();
                } else {
                    location.search = query.toString();
                }

                return false;
            });

        $("a.album-toggle").live("click", function () {
            var thumbnail = $(this).parents(".table.image-wrapper").find(".thumbnail");
            var tab = $("#sideTabs .tab.album");

            if ($(this).hasClass("in-album")) {
                tab.effect("transfer", { to: thumbnail, className: "ui-effects-transfer remove-from-album" }, 500);
            } else {
                thumbnail.effect("transfer", { to: tab, className: "ui-effects-transfer add-to-album" }, 500);
            }
        });
    }

    if ($('.page-photo').length > 0) {
        $("#lnkSearchByTags")
            .button()
            .live("click", function () {
                var tags = [];

                $('#dlRelatedTags input[type="checkbox"]:checked').each(function (i, e) {
                    tags.push($(e).parent("span").attr("data-id"));
                });

                if (tags.length > 0) {
                    var filter = {
                        tags: tags
                    };

                    var location = $(this).attr("href") + $.query.empty().set("filter", JSON.stringify(filter)).toString();
                    document.location = location;
                }

                return false;
            });
    }

    if ($(".page-myalbum").length > 0) {
        $("#lnkSelectAll").click(function () {
            $('.page-myalbum .items input[type="checkbox"]').prop("checked", true);
            return false;
        });

        $("#lnkDeselectAll").click(function () {
            $('.page-myalbum .items input[type="checkbox"]').prop("checked", false);
            return false;
        });
    }

    if ($(".page-register").length > 0) {
        var apply = function () {
            if ($(this).is(":checked")) {
                $(".validation-error", "#photographerPanel").each(function () {
                    ValidatorEnable(this, true);
                });
                $("#photographerPanel").show();
            } else {
                $(".validation-error", "#photographerPanel").each(function () {
                    ValidatorEnable(this, false);
                });
                $("#photographerPanel").hide();
            }
        };

        apply.call($("#chkIsPhotographer"));
        $("#chkIsPhotographer").live("change", apply);
    }


    $('a[data-preview-url]').hoverIntent(function (e) {
        var rtl = $("body").is(".he");
        var thumbnailUrl = $("img", this).attr("src");
        var previewUrl = $(this).attr("data-preview-url");

        var width = $("img", this).width() * (500 / 150);
        var height = $("img", this).height() * (500 / 150);

        $("body").append("<div id='photo-preview'><img src='" + thumbnailUrl + "' alt='url preview' /></div>");
        $("#photo-preview").hide();

        $("#photo-preview img").css({
            width: width,
            height: height
        });

        $(new Image())
            .load(function () {
                var img = $("#photo-preview img");
                if (img.attr("src") === thumbnailUrl) {
                    $(img).attr("src", previewUrl);
                }
            })
            .attr("src", previewUrl);

        $("#photo-preview")
            .position({
                my: (rtl ? "right" : "left") + " center",
                at: (rtl ? "left" : "right") + " center",
                of: $(this),
                offset: "-5 0",
                collision: "flip fit"
            })
            .fadeIn("fast");
    },
    function () {
        $("#photo-preview").remove();
    });

    $(".js").removeClass("js");

    function SerializeArray(arr) {
        if (arr.length == 1) {
            return arr[0];
        } else if (arr.length > 1) {
            return "[" + arr.join(",") + "]";
        }

        return "";
    }
});